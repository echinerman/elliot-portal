<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#fafaf9', 100: '#f5f5f4', 800: '#292524', 900: '#1c1917' } // Stone theme
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-brand-50 text-brand-900 min-h-screen font-sans antialiased">

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-4 right-4 z-50 transform transition-all duration-300 translate-x-full opacity-0">
        <div class="bg-brand-900 text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3">
            <i id="toast-icon" class="fa-solid fa-circle-check"></i>
            <span id="toast-msg">Success</span>
        </div>
    </div>

    <!-- AUTH CONTAINER -->
    <div id="auth-view" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl">
            <h1 class="text-2xl font-bold mb-6 text-center text-brand-800">Client Portal</h1>
            
            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="Email" class="w-full p-3 bg-brand-50 rounded-xl border-none focus:ring-2 focus:ring-brand-800 outline-none" required>
                <input type="password" id="login-pass" placeholder="Password" class="w-full p-3 bg-brand-50 rounded-xl border-none focus:ring-2 focus:ring-brand-800 outline-none" required>
                <button type="submit" class="w-full bg-brand-900 text-white font-semibold py-3 rounded-xl hover:bg-brand-800 transition">Sign In</button>
                <div class="text-center text-sm text-gray-500 mt-4">
                    Need an account? <a href="#" onclick="toggleAuth('register')" class="text-brand-900 font-bold hover:underline">Register</a>
                </div>
            </form>

            <!-- Register Form (Hidden) -->
            <form id="register-form" class="space-y-4 hidden">
                <input type="text" id="reg-code" placeholder="Invite Code" class="w-full p-3 bg-brand-50 rounded-xl border-none focus:ring-2 focus:ring-brand-800 outline-none" required>
                <input type="email" id="reg-email" placeholder="Email" class="w-full p-3 bg-brand-50 rounded-xl border-none focus:ring-2 focus:ring-brand-800 outline-none" required>
                <input type="password" id="reg-pass" placeholder="Password" class="w-full p-3 bg-brand-50 rounded-xl border-none focus:ring-2 focus:ring-brand-800 outline-none" required>
                <button type="submit" class="w-full bg-brand-900 text-white font-semibold py-3 rounded-xl hover:bg-brand-800 transition">Create Account</button>
                <div class="text-center text-sm text-gray-500 mt-4">
                    Have an account? <a href="#" onclick="toggleAuth('login')" class="text-brand-900 font-bold hover:underline">Sign In</a>
                </div>
            </form>
        </div>
    </div>

    <!-- DASHBOARD CONTAINER (Hidden by default) -->
    <div id="dashboard-view" class="hidden max-w-6xl mx-auto p-4 lg:p-8 space-y-8">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm gap-4">
            <div>
                <h2 class="text-xl font-bold">Welcome, <span id="user-name-display" class="font-normal text-gray-600">Client</span></h2>
                <div class="text-xs text-gray-400 mt-1" id="user-email-display"></div>
            </div>
            <div class="flex items-center gap-4">
                <button id="logout-btn" class="text-brand-900 hover:text-red-600 transition px-2 flex items-center gap-2">
                    <span class="text-sm font-bold">Sign Out</span>
                    <i class="fa-solid fa-right-from-bracket fa-lg"></i>
                </button>
            </div>
        </header>

        <!-- Global Server Info -->
        <div class="bg-brand-900 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
            <div class="absolute top-0 right-0 p-8 opacity-10"><i class="fa-solid fa-server text-9xl"></i></div>
            <h3 class="text-lg font-bold mb-4 relative z-10"><i class="fa-solid fa-network-wired mr-2"></i> Server Connection</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10">
                <div class="bg-white/10 p-3 rounded-xl backdrop-blur-sm">
                    <label class="text-[10px] uppercase font-bold text-white/50 block mb-1">Main Server URL (DNS)</label>
                    <div class="flex items-center justify-between">
                        <code id="global-domain" class="font-mono text-sm">Loading...</code>
                        <button onclick="copyText('global-domain')" class="text-white/70 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                    </div>
                </div>
                <div class="bg-white/10 p-3 rounded-xl backdrop-blur-sm">
                    <label class="text-[10px] uppercase font-bold text-white/50 block mb-1">Backup Server URL</label>
                    <div class="flex items-center justify-between">
                        <code id="global-backup" class="font-mono text-sm">Loading...</code>
                        <button onclick="copyText('global-backup')" class="text-white/70 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Licenses (My Subscriptions) -->
            <div class="lg:col-span-2 space-y-6">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-ticket"></i> My Active Licenses</h3>
                </div>

                <!-- Dynamic License Container -->
                <div id="licenses-container" class="space-y-4">
                    <!-- Loaded via JS -->
                    <div class="bg-white p-8 rounded-2xl text-center text-gray-400">Loading licenses...</div>
                </div>
            </div>

            <!-- Right Column: Tools & Config -->
            <div class="space-y-8">
                
                <!-- Calculator Card -->
                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-calculator"></i> Renewal Calculator</h3>
                    
                    <div class="flex bg-brand-50 p-1 rounded-xl mb-6">
                        <button onclick="setCalcMode('interac')" id="btn-interac" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm transition">Interac</button>
                        <button onclick="setCalcMode('btc')" id="btn-btc" class="flex-1 py-2 rounded-lg text-sm font-bold text-gray-500 hover:text-brand-900 transition">Bitcoin</button>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Select Package</label>
                            <select id="calc-product" class="w-full p-2 bg-brand-50 rounded-lg border-none outline-none text-sm"></select>
                        </div>
                        
                        <div class="bg-brand-900 text-white p-4 rounded-xl flex justify-between items-center mt-4">
                            <span>Total:</span>
                            <span id="calc-total" class="text-xl font-bold">$0.00</span>
                        </div>

                        <p id="calc-instructions" class="text-xs text-gray-500 mt-2 leading-relaxed">
                            <!-- Dynamic Instructions based on toggle -->
                        </p>
                    </div>
                </div>

                <!-- Configuration Card -->
                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-sliders"></i> Preferences</h3>
                    
                    <div class="space-y-4">
                        <!-- Devices -->
                        <div>
                            <h4 class="text-xs font-bold uppercase text-gray-400 mb-2">Device Inventory (For Support)</h4>
                            <p class="text-[11px] text-gray-500 mb-2 leading-tight">Adding a device here does not create a new connection line. To add a screen, please contact Elliot.</p>
                            <div id="device-list" class="space-y-2 mb-2"></div>
                            <div class="flex gap-2">
                                <select id="new-device-select" class="flex-1 p-2 bg-brand-50 rounded-lg text-sm"></select>
                                <button id="add-device-btn" class="bg-brand-800 text-white px-3 rounded-lg hover:bg-brand-900"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>

                        <!-- Live TV Categories -->
                        <div>
                            <h4 class="text-xs font-bold uppercase text-gray-400 mb-2">Live TV Preferences</h4>
                            <select id="live-pref-select" class="w-full p-2 bg-brand-50 rounded-lg text-sm mb-2"></select>
                            <div id="live-tags" class="flex flex-wrap gap-2"></div>
                        </div>

                        <!-- VOD Categories -->
                        <div>
                            <h4 class="text-xs font-bold uppercase text-gray-400 mb-2">VOD Preferences</h4>
                            <select id="vod-pref-select" class="w-full p-2 bg-brand-50 rounded-lg text-sm mb-2"></select>
                            <div id="vod-tags" class="flex flex-wrap gap-2"></div>
                        </div>

                        <!-- Custom Request -->
                        <div>
                            <h4 class="text-xs font-bold uppercase text-gray-400 mb-2">Custom Request</h4>
                            <textarea id="custom-req" rows="2" class="w-full p-2 bg-brand-50 rounded-lg text-sm" placeholder="e.g. Italian channels..."></textarea>
                        </div>
                    </div>
                    <button id="save-config-btn" class="mt-6 w-full bg-brand-900 text-white px-6 py-2 rounded-xl text-sm font-bold hover:bg-brand-800 transition">Save Preferences</button>
                </div>

                 <!-- Support -->
                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <h3 class="text-lg font-bold mb-4"><i class="fa-solid fa-headset mr-2"></i>Support</h3>
                     <a id="contact-link" href="#" class="block w-full text-center bg-gray-100 text-brand-900 font-bold py-3 rounded-xl hover:bg-gray-200 transition">
                        Contact Elliot
                    </a>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { CONFIG } from './config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged,
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc,
            collection,
            query, 
            where,
            getDocs,
            runTransaction,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- INIT FIREBASE ---
        const app = initializeApp(CONFIG.FIREBASE);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUserData = null;
        let products = [];
        let availableDevices = [];
        let contentOptions = { live_list: [], vod_list: [] };
        let calcMode = 'interac';

        // --- UI FUNCTIONS ---
        window.toggleAuth = (view) => {
            document.getElementById('login-form').classList.toggle('hidden', view === 'register');
            document.getElementById('register-form').classList.toggle('hidden', view !== 'register');
        };

        window.copyText = (elementId) => {
            const el = document.getElementById(elementId);
            const text = el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' ? el.value : el.textContent;
            navigator.clipboard.writeText(text);
            showToast('Copied to clipboard');
        };

        window.copyString = (str) => {
            navigator.clipboard.writeText(str);
            showToast('Copied to clipboard');
        }

        window.setCalcMode = (mode) => {
            calcMode = mode;
            document.getElementById('btn-interac').className = mode === 'interac' ? 'flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm transition' : 'flex-1 py-2 rounded-lg text-sm font-bold text-gray-500 hover:text-brand-900 transition';
            document.getElementById('btn-btc').className = mode === 'btc' ? 'flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm transition' : 'flex-1 py-2 rounded-lg text-sm font-bold text-gray-500 hover:text-brand-900 transition';
            updateCalculator();
        };

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            toast.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-x-full', 'opacity-0'), 3000);
        }

        function updateCalculator() {
            // Quantity is always 1 for subscriptions/donations in this view
            const qty = 1; 
            const productId = document.getElementById('calc-product').value;
            const product = products.find(p => p.id === productId);
            
            if(!product) return;

            const total = qty * product.price;
            document.getElementById('calc-total').textContent = `${CONFIG.CURRENCY_SYMBOL}${total.toFixed(2)}`;
            
            const instructions = calcMode === 'interac' 
                ? `Please e-Transfer <b>${CONFIG.CURRENCY_SYMBOL}${total.toFixed(2)}</b> to <u>payments@example.com</u> using your email as the security answer.`
                : `Send <b>${CONFIG.CRYPTO_SYMBOL}${(total / 95000).toFixed(6)}</b> (est) to wallet: <u>bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh</u>`;
            
            document.getElementById('calc-instructions').innerHTML = instructions;
        }

        // --- CORE LOGIC ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
                document.getElementById('user-email-display').textContent = user.email;
                document.getElementById('contact-link').href = CONFIG.CONTACT_LINK;
                
                await loadDashboardData(user);
            } else {
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('dashboard-view').classList.add('hidden');
            }
        });

        async function loadDashboardData(user) {
            // 1. Fetch User Data First (Needed for conditional products)
            const userDocRef = doc(db, 'users', user.uid);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                currentUserData = userDoc.data();
                renderUserData(currentUserData);
            } else {
                console.error("User doc missing"); 
                return;
            }

            // 2. Fetch Configs & Products
            const configSnap = await getDocs(collection(db, 'app_config'));
            const productSnap = await getDocs(collection(db, 'products'));
            
            configSnap.forEach(doc => {
                if(doc.id === 'devices') availableDevices = doc.data().list || [];
                if(doc.id === 'content_options') contentOptions = doc.data();
            });

            products = [];
            productSnap.forEach(doc => {
                const p = { id: doc.id, ...doc.data() };
                products.push(p);
            });
            products.sort((a,b) => a.price - b.price);

            // 3. Conditional Product Logic (Donation)
            // Check if ANY license has an EPGenius URL
            const hasEPGenius = currentUserData.licenses && currentUserData.licenses.some(l => l.epgenius_url && l.epgenius_url.trim() !== "");
            
            if (hasEPGenius) {
                products.push({
                    id: 'donation_epgenius',
                    name: 'Donate to EPGenius Curator (One-time)',
                    price: 20
                });
            }

            // Render Product Dropdown
            const prodSelect = document.getElementById('calc-product');
            prodSelect.innerHTML = '';
            products.forEach(p => {
                 const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `${p.name} - ${CONFIG.CURRENCY_SYMBOL}${p.price}`;
                prodSelect.appendChild(opt);
            });

            document.getElementById('calc-product').addEventListener('change', updateCalculator);
            updateCalculator(); // init
            renderConfigUI();
        }

        function renderUserData(data) {
            // Header
            document.getElementById('user-name-display').textContent = data.full_name || 'Client';
            // Wallet balance removed
            document.getElementById('global-domain').textContent = data.domain_8k || 'Contact Admin';
            document.getElementById('global-backup').textContent = data.domain_8k_backup || 'Contact Admin';

            // Licenses Loop
            const licContainer = document.getElementById('licenses-container');
            licContainer.innerHTML = '';
            
            const licenses = data.licenses || [];
            
            if (licenses.length === 0) {
                // Fallback for legacy single-field users
                if(data.username_8k) {
                     licContainer.innerHTML = createLicenseCard({
                        label: 'Primary Connection',
                        username_8k: data.username_8k,
                        password_8k: data.password_8k,
                        expiry_date: data.expiry_date,
                        status: data.status,
                        m3u_url_8k: data.m3u_url_8k,
                        epg_url_8k: data.epg_url_8k
                     });
                } else {
                     licContainer.innerHTML = `<div class="bg-white p-8 rounded-2xl text-center border-2 border-dashed border-gray-200 text-gray-400">
                        <i class="fa-solid fa-ticket text-4xl mb-2"></i><br>
                        No active licenses found. Please contact Elliot.
                     </div>`;
                }
            } else {
                licenses.forEach(lic => {
                    licContainer.innerHTML += createLicenseCard(lic);
                });
            }
        }

        function createLicenseCard(lic) {
            let statusColor = 'bg-gray-100 text-gray-500';
            if(lic.status === 'Active') statusColor = 'bg-green-100 text-green-700';
            if(lic.status === 'Expired') statusColor = 'bg-red-100 text-red-700';
            if(lic.status === 'Banned') statusColor = 'bg-black text-white';

            return `
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative group transition hover:shadow-md">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h4 class="font-bold text-lg text-brand-900">${lic.label || 'License'}</h4>
                        <div class="text-xs text-gray-400 font-mono mt-1">EXP: ${lic.expiry_date || 'N/A'}</div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-bold ${statusColor}">${lic.status || 'Unknown'}</span>
                </div>

                <div class="space-y-3 bg-brand-50 p-4 rounded-xl">
                    <!-- User/Pass -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] uppercase font-bold text-gray-400 block mb-1">Username</label>
                            <div class="flex items-center justify-between bg-white p-2 rounded border border-gray-200">
                                <span class="text-sm font-mono text-gray-700 select-all">${lic.username_8k}</span>
                                <button onclick="copyString('${lic.username_8k}')" class="text-gray-300 hover:text-brand-900"><i class="fa-regular fa-copy"></i></button>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-gray-400 block mb-1">Password</label>
                            <div class="flex items-center justify-between bg-white p-2 rounded border border-gray-200">
                                <span class="text-sm font-mono text-gray-700 select-all">${lic.password_8k}</span>
                                <button onclick="copyString('${lic.password_8k}')" class="text-gray-300 hover:text-brand-900"><i class="fa-regular fa-copy"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Links -->
                    ${lic.m3u_url_8k ? `
                    <div>
                        <label class="text-[10px] uppercase font-bold text-gray-400 block mb-1">8K M3U URL</label>
                        <div class="flex items-center justify-between bg-white p-2 rounded border border-gray-200">
                            <input readonly value="${lic.m3u_url_8k}" class="w-full text-xs font-mono text-gray-500 bg-transparent outline-none">
                            <button onclick="copyString('${lic.m3u_url_8k}')" class="ml-2 text-gray-300 hover:text-brand-900"><i class="fa-regular fa-copy"></i></button>
                        </div>
                    </div>` : ''}
                    
                     ${lic.epgenius_url ? `
                    <div>
                        <label class="text-[10px] uppercase font-bold text-blue-400 block mb-1">EPGenius Playlist URL</label>
                        <div class="flex items-center justify-between bg-white p-2 rounded border border-blue-100">
                            <input readonly value="${lic.epgenius_url}" class="w-full text-xs font-mono text-gray-500 bg-transparent outline-none">
                            <button onclick="copyString('${lic.epgenius_url}')" class="ml-2 text-gray-300 hover:text-blue-600"><i class="fa-regular fa-copy"></i></button>
                        </div>
                    </div>` : ''}

                </div>
            </div>`;
        }

        function renderConfigUI() {
            // Devices
            const deviceList = document.getElementById('device-list');
            deviceList.innerHTML = '';
            const userDevices = currentUserData?.devices || [];
            
            userDevices.forEach(dev => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-50 p-2 rounded text-sm';
                div.innerHTML = `<span>${dev}</span> <button onclick="removeDevice('${dev}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-times"></i></button>`;
                deviceList.appendChild(div);
            });

            const devSelect = document.getElementById('new-device-select');
            devSelect.innerHTML = '<option value="">Select Device...</option>';
            availableDevices.forEach(d => {
                if(!userDevices.includes(d)) {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    devSelect.appendChild(opt);
                }
            });

            // Config Selectors Helper
            const renderTags = (containerId, selectedList, allOptions, type) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                selectedList.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'bg-brand-900 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2';
                    btn.innerHTML = `${item} <i class="fa-solid fa-times"></i>`;
                    btn.onclick = () => togglePref(type, item);
                    container.appendChild(btn);
                });

                const select = document.getElementById(type === 'live' ? 'live-pref-select' : 'vod-pref-select');
                select.innerHTML = `<option value="">Add ${type === 'live' ? 'Live' : 'VOD'} Category...</option>`;
                allOptions.forEach(opt => {
                    if(!selectedList.includes(opt)) {
                        const o = document.createElement('option');
                        o.value = opt;
                        o.textContent = opt;
                        select.appendChild(o);
                    }
                });
            };

            renderTags('live-tags', currentUserData.live_preferences || [], contentOptions.live_list || [], 'live');
            renderTags('vod-tags', currentUserData.vod_preferences || [], contentOptions.vod_list || [], 'vod');

            document.getElementById('custom-req').value = currentUserData.custom_request || '';

            // Event listeners for dropdowns
            document.getElementById('live-pref-select').onchange = (e) => { if(e.target.value) togglePref('live', e.target.value); };
            document.getElementById('vod-pref-select').onchange = (e) => { if(e.target.value) togglePref('vod', e.target.value); };
        }

        // --- ACTIONS ---

        window.removeDevice = async (device) => {
            const userRef = doc(db, 'users', auth.currentUser.uid);
            await updateDoc(userRef, { devices: arrayRemove(device) });
            // Optimistic update
            currentUserData.devices = currentUserData.devices.filter(d => d !== device);
            renderConfigUI();
            showToast('Device removed');
        };

        document.getElementById('add-device-btn').addEventListener('click', async () => {
            const val = document.getElementById('new-device-select').value;
            if(!val) return;
            const userRef = doc(db, 'users', auth.currentUser.uid);
            await updateDoc(userRef, { devices: arrayUnion(val) });
            if(!currentUserData.devices) currentUserData.devices = [];
            currentUserData.devices.push(val);
            renderConfigUI();
            showToast('Device added');
        });

        window.togglePref = async (type, val) => {
            const field = type === 'live' ? 'live_preferences' : 'vod_preferences';
            let list = currentUserData[field] || [];
            
            if(list.includes(val)) {
                list = list.filter(i => i !== val);
            } else {
                list.push(val);
            }

            // Local update for immediate UI feel
            currentUserData[field] = list;
            renderConfigUI();
        };

        document.getElementById('save-config-btn').addEventListener('click', async () => {
            const userRef = doc(db, 'users', auth.currentUser.uid);
            await updateDoc(userRef, {
                live_preferences: currentUserData.live_preferences || [],
                vod_preferences: currentUserData.vod_preferences || [],
                custom_request: document.getElementById('custom-req').value
            });
            showToast('Preferences Saved');
        });

        // --- AUTH & MIGRATION ---

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                showToast(err.message);
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('reg-code').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;

            if (code !== CONFIG.INVITE_CODE) {
                showToast("Invalid Invite Code");
                return;
            }

            try {
                const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCred.user;

                // MIGRATION LOGIC
                const q = query(collection(db, "users"), where("email", "==", email));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // Claim existing admin-created doc
                    const oldDoc = querySnapshot.docs[0];
                    const oldData = oldDoc.data();
                    
                    await runTransaction(db, async (transaction) => {
                        const newDocRef = doc(db, "users", user.uid);
                        const oldDocRef = doc(db, "users", oldDoc.id);
                        transaction.set(newDocRef, oldData);
                        transaction.delete(oldDocRef);
                    });
                    showToast('Account claimed successfully!');
                } else {
                    // New User - Initialize with NEW SCHEMA arrays
                    await setDoc(doc(db, "users", user.uid), {
                        email: email,
                        status: "Pending",
                        created_at: new Date().toISOString(),
                        devices: [],
                        licenses: [], // Empty array for new users
                        live_preferences: ["Elliot's Default (QC + Sports + English)"], 
                        vod_preferences: ["Elliot's Default (Movies & Series)"], 
                        custom_request: "",
                        credits_allocated: 0
                    });
                    showToast('Account created successfully!');
                }
            } catch (err) {
                console.error(err);
                showToast(err.message);
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
    </script>
</body>
</html>
