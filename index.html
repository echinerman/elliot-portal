<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#fafaf9', 100: '#f5f5f4', 800: '#292524', 900: '#1c1917' } // Stone theme
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-brand-50 text-brand-900 min-h-screen font-sans antialiased">

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-4 right-4 z-50 transform transition-all duration-300 translate-x-full opacity-0">
        <div class="bg-brand-900 text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3">
            <i id="toast-icon" class="fa-solid fa-circle-check"></i>
            <span id="toast-msg">Success</span>
        </div>
    </div>

    <!-- AUTH CONTAINER -->
    <div id="auth-view" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl">
            <h1 class="text-2xl font-bold mb-6 text-center text-brand-800">Client Portal</h1>
            
            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="Email" class="w-full p-3 bg-brand-50 rounded-xl border-none focus:ring-2 focus:ring-brand-800 outline-none" required>
                <input type="password" id="login-pass" placeholder="Password" class="w-full p-3 bg-brand-50 rounded-xl border-none focus:ring-2 focus:ring-brand-800 outline-none" required>
                <button type="submit" class="w-full bg-brand-900 text-white font-semibold py-3 rounded-xl hover:bg-brand-800 transition">Sign In</button>
                <div class="text-center text-sm text-gray-500 mt-4">
                    Need an account? <a href="#" onclick="toggleAuth('register')" class="text-brand-900 font-bold hover:underline">Register</a>
                </div>
            </form>

            <!-- Register Form (Hidden) -->
            <form id="register-form" class="space-y-4 hidden">
                <input type="text" id="reg-code" placeholder="Invite Code" class="w-full p-3 bg-brand-50 rounded-xl border-none focus:ring-2 focus:ring-brand-800 outline-none" required>
                <input type="email" id="reg-email" placeholder="Email" class="w-full p-3 bg-brand-50 rounded-xl border-none focus:ring-2 focus:ring-brand-800 outline-none" required>
                <input type="password" id="reg-pass" placeholder="Password" class="w-full p-3 bg-brand-50 rounded-xl border-none focus:ring-2 focus:ring-brand-800 outline-none" required>
                <button type="submit" class="w-full bg-brand-900 text-white font-semibold py-3 rounded-xl hover:bg-brand-800 transition">Create Account</button>
                <div class="text-center text-sm text-gray-500 mt-4">
                    Have an account? <a href="#" onclick="toggleAuth('login')" class="text-brand-900 font-bold hover:underline">Sign In</a>
                </div>
            </form>
        </div>
    </div>

    <!-- DASHBOARD CONTAINER (Hidden by default) -->
    <div id="dashboard-view" class="hidden max-w-6xl mx-auto p-4 lg:p-8 space-y-12">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm gap-4">
            <div>
                <h2 class="text-xl font-bold">Welcome, <span id="user-name-display" class="font-normal text-gray-600">Client</span></h2>
                <div class="text-xs text-gray-400 mt-1" id="user-email-display"></div>
            </div>
            <div class="flex items-center gap-4">
                <button id="logout-btn" class="text-brand-900 hover:text-red-600 transition px-2 flex items-center gap-2">
                    <span class="text-sm font-bold">Sign Out</span>
                    <i class="fa-solid fa-right-from-bracket fa-lg"></i>
                </button>
            </div>
        </header>

        <!-- SECTION 1: STATUS & ACCESS -->
        <div class="space-y-6">
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Connection Status</h3>
            
            <!-- Global Server Info -->
            <div class="bg-brand-900 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
                <div class="absolute top-0 right-0 p-8 opacity-10"><i class="fa-solid fa-server text-9xl"></i></div>
                <h3 class="text-lg font-bold mb-4 relative z-10"><i class="fa-solid fa-network-wired mr-2"></i> Server Connection</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10">
                    <div class="bg-white/10 p-3 rounded-xl backdrop-blur-sm">
                        <label class="text-[10px] uppercase font-bold text-white/50 block mb-1">Main Server URL (DNS)</label>
                        <div class="flex items-center justify-between">
                            <code id="global-domain" class="font-mono text-sm">Loading...</code>
                            <button onclick="copyText('global-domain')" class="text-white/70 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                        </div>
                    </div>
                    <div class="bg-white/10 p-3 rounded-xl backdrop-blur-sm">
                        <label class="text-[10px] uppercase font-bold text-white/50 block mb-1">Backup Server URL</label>
                        <div class="flex items-center justify-between">
                            <code id="global-backup" class="font-mono text-sm">Loading...</code>
                            <button onclick="copyText('global-backup')" class="text-white/70 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Licenses -->
            <div id="licenses-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Loaded via JS -->
                <div class="bg-white p-8 rounded-2xl text-center text-gray-400 col-span-full">Loading licenses...</div>
            </div>
        </div>

        <!-- SECTION 2: SHOP / PACKAGES -->
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Available Packages</h3>
            </div>
            
            <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Products Loaded JS -->
            </div>

            <!-- Hidden Purchase Instructions Modal (Replaces Calculator) -->
            <div id="purchase-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in-up">
                    <div class="bg-brand-900 p-6 text-white text-center">
                        <h4 class="text-lg font-bold" id="modal-product-name">Package Name</h4>
                        <div class="text-3xl font-bold mt-2" id="modal-product-price">$0.00</div>
                    </div>
                    <div class="p-8 space-y-6">
                        <div class="text-center space-y-2">
                            <p class="text-sm text-gray-500 font-medium">To activate this license, please send an e-transfer to:</p>
                            <div class="bg-gray-100 p-3 rounded-xl font-mono text-brand-900 font-bold select-all cursor-pointer hover:bg-gray-200 transition" onclick="copyString('e.chinerman@gmail.com')">
                                e.chinerman@gmail.com
                            </div>
                            <p class="text-xs text-gray-400">Tap email to copy</p>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-100 p-4 rounded-xl text-xs text-yellow-800 leading-relaxed">
                            <i class="fa-solid fa-circle-info mr-1"></i>
                            <strong>Note:</strong> Elliot will process your order and activate your license only after payment is received.
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="closeModal('purchase-modal')" class="py-3 rounded-xl text-gray-500 font-bold hover:bg-gray-50">Cancel</button>
                            <a id="notify-link" href="#" class="py-3 rounded-xl bg-brand-900 text-white font-bold text-center hover:bg-brand-800 shadow-lg shadow-brand-900/20">
                                I've Sent Payment
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 3: CONFIGURATION -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Device Inventory Widget -->
            <div class="bg-white p-6 rounded-2xl shadow-sm h-full">
                <h3 class="text-lg font-bold mb-1 flex items-center gap-2"><i class="fa-solid fa-mobile-screen-button"></i> Device Inventory</h3>
                <p class="text-[11px] text-gray-400 mb-6">List your hardware for support reference.</p>
                
                <div class="flex gap-2 mb-4">
                    <div class="relative flex-1">
                        <input type="text" id="new-device-name" placeholder="Device Name (e.g. Bedroom TV)" class="w-full pl-3 pr-10 py-2 bg-gray-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-brand-900 outline-none">
                    </div>
                    <select id="new-device-type" class="bg-gray-50 rounded-xl text-sm border-none outline-none px-2 text-brand-900 font-bold cursor-pointer">
                        <option value="tv">ðŸ“º TV</option>
                        <option value="box">ðŸ“¦ Box</option>
                        <option value="mobile">ðŸ“± Phone</option>
                        <option value="laptop">ðŸ’» PC</option>
                    </select>
                    <button id="add-device-btn" class="bg-brand-900 text-white w-10 h-10 rounded-xl flex items-center justify-center hover:bg-brand-800 shadow-sm"><i class="fa-solid fa-plus"></i></button>
                </div>

                <div id="device-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    <!-- Dynamic Device Cards -->
                </div>
            </div>

            <!-- Viewing Category Preferences -->
            <div class="bg-white p-6 rounded-2xl shadow-sm h-full flex flex-col">
                <h3 class="text-lg font-bold mb-1 flex items-center gap-2"><i class="fa-solid fa-sliders"></i> Viewing Category Preferences</h3>
                <p class="text-[11px] text-gray-400 mb-6">Customize your playlist content.</p>
                
                <div class="space-y-6 flex-1">
                    <!-- Live TV -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xs font-bold uppercase text-brand-900">Live TV</h4>
                            <select id="live-pref-select" class="text-xs bg-transparent text-gray-400 outline-none cursor-pointer hover:text-brand-900 text-right w-1/2"></select>
                        </div>
                        <div id="live-tags" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- VOD -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xs font-bold uppercase text-brand-900">Movies & Series</h4>
                            <select id="vod-pref-select" class="text-xs bg-transparent text-gray-400 outline-none cursor-pointer hover:text-brand-900 text-right w-1/2"></select>
                        </div>
                        <div id="vod-tags" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- Custom Request -->
                    <div>
                        <h4 class="text-xs font-bold uppercase text-brand-900 mb-2">Special Requests</h4>
                        <textarea id="custom-req" rows="2" class="w-full p-3 bg-gray-50 rounded-xl text-sm border-none focus:ring-1 focus:ring-brand-900 outline-none resize-none" placeholder="e.g. Specific international channels..."></textarea>
                    </div>
                </div>
                <button id="save-config-btn" class="mt-6 w-full bg-gray-100 text-brand-900 px-6 py-3 rounded-xl text-sm font-bold hover:bg-gray-200 transition">Save Preferences</button>
            </div>

        </div>

        <!-- Footer / Support -->
        <div class="text-center pt-8 border-t border-gray-200">
            <p class="text-gray-400 text-sm mb-4">Need help setting up?</p>
            <a id="contact-link" href="#" class="inline-flex items-center gap-2 text-brand-900 font-bold hover:underline">
                <i class="fa-regular fa-envelope"></i> Contact Elliot
            </a>
        </div>
    </div>

    <script type="module">
        import { CONFIG } from './config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged,
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc,
            collection,
            query, 
            where,
            getDocs,
            runTransaction,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- INIT FIREBASE ---
        const app = initializeApp(CONFIG.FIREBASE);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUserData = null;
        let products = [];
        let contentOptions = { live_list: [], vod_list: [] };

        // --- UI FUNCTIONS ---
        window.toggleAuth = (view) => {
            document.getElementById('login-form').classList.toggle('hidden', view === 'register');
            document.getElementById('register-form').classList.toggle('hidden', view !== 'register');
        };

        window.copyText = (elementId) => {
            const el = document.getElementById(elementId);
            const text = el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' ? el.value : el.textContent;
            navigator.clipboard.writeText(text);
            showToast('Copied to clipboard');
        };

        window.copyString = (str) => {
            navigator.clipboard.writeText(str);
            showToast('Copied to clipboard');
        }

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            toast.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-x-full', 'opacity-0'), 3000);
        }

        // --- CORE LOGIC ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
                document.getElementById('user-email-display').textContent = user.email;
                document.getElementById('contact-link').href = CONFIG.CONTACT_LINK;
                
                await loadDashboardData(user);
            } else {
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('dashboard-view').classList.add('hidden');
            }
        });

        async function loadDashboardData(user) {
            // 1. Fetch User Data
            const userDocRef = doc(db, 'users', user.uid);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                currentUserData = userDoc.data();
                renderUserData(currentUserData);
            } else {
                console.error("User doc missing"); 
                return;
            }

            // 2. Fetch Configs & Products
            const configSnap = await getDocs(collection(db, 'app_config'));
            const productSnap = await getDocs(collection(db, 'products'));
            
            configSnap.forEach(doc => {
                if(doc.id === 'content_options') contentOptions = doc.data();
            });

            products = [];
            productSnap.forEach(doc => {
                const p = { id: doc.id, ...doc.data() };
                products.push(p);
            });
            products.sort((a,b) => a.price - b.price);

            // Conditional Donation Product
            const hasEPGenius = currentUserData.licenses && currentUserData.licenses.some(l => l.epgenius_url && l.epgenius_url.trim() !== "");
            if (hasEPGenius) {
                products.push({ id: 'donation_epgenius', name: 'Donate to EPGenius Curator', price: 20 });
            }

            renderProductGrid();
            renderConfigUI();
        }

        function renderUserData(data) {
            document.getElementById('user-name-display').textContent = data.full_name || 'Client';
            document.getElementById('global-domain').textContent = data.domain_8k || 'Contact Admin';
            document.getElementById('global-backup').textContent = data.domain_8k_backup || 'Contact Admin';

            const licContainer = document.getElementById('licenses-container');
            licContainer.innerHTML = '';
            
            const licenses = data.licenses || [];
            
            if (licenses.length === 0) {
                if(data.username_8k) {
                     licContainer.innerHTML = createLicenseCard({
                        label: 'Primary Connection',
                        username_8k: data.username_8k,
                        password_8k: data.password_8k,
                        expiry_date: data.expiry_date,
                        status: data.status,
                        m3u_url_8k: data.m3u_url_8k,
                        epg_url_8k: data.epg_url_8k
                     });
                } else {
                     licContainer.innerHTML = `<div class="bg-gray-50 p-8 rounded-2xl text-center border-2 border-dashed border-gray-200 text-gray-400 col-span-full">
                        <i class="fa-solid fa-ticket text-3xl mb-2 opacity-50"></i><br>
                        No active licenses found.<br>Select a package below to get started.
                     </div>`;
                }
            } else {
                licenses.forEach(lic => {
                    licContainer.innerHTML += createLicenseCard(lic);
                });
            }
        }

        function createLicenseCard(lic) {
            let statusColor = 'bg-gray-100 text-gray-500';
            if(lic.status === 'Active') statusColor = 'bg-green-100 text-green-700';
            if(lic.status === 'Expired') statusColor = 'bg-red-100 text-red-700';
            if(lic.status === 'Banned') statusColor = 'bg-black text-white';

            return `
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative group transition hover:shadow-md">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-brand-50 flex items-center justify-center text-brand-900"><i class="fa-solid fa-tv"></i></div>
                        <div>
                            <h4 class="font-bold text-base text-brand-900 leading-tight">${lic.label || 'License'}</h4>
                            <div class="text-[10px] text-gray-400 font-mono mt-0.5">EXP: ${lic.expiry_date || 'N/A'}</div>
                        </div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-[10px] uppercase font-bold ${statusColor}">${lic.status || 'Unknown'}</span>
                </div>

                <div class="space-y-3 bg-brand-50 p-4 rounded-xl">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1">Username</label>
                            <div class="flex items-center justify-between bg-white p-1.5 rounded border border-gray-200 cursor-pointer hover:border-brand-900 group/input" onclick="copyString('${lic.username_8k}')">
                                <span class="text-xs font-mono text-gray-700 select-all truncate">${lic.username_8k}</span>
                                <i class="fa-regular fa-copy text-[10px] text-gray-300 group-hover/input:text-brand-900"></i>
                            </div>
                        </div>
                        <div>
                            <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1">Password</label>
                            <div class="flex items-center justify-between bg-white p-1.5 rounded border border-gray-200 cursor-pointer hover:border-brand-900 group/input" onclick="copyString('${lic.password_8k}')">
                                <span class="text-xs font-mono text-gray-700 select-all truncate">${lic.password_8k}</span>
                                <i class="fa-regular fa-copy text-[10px] text-gray-300 group-hover/input:text-brand-900"></i>
                            </div>
                        </div>
                    </div>

                    ${lic.m3u_url_8k ? `
                    <div>
                        <label class="text-[9px] uppercase font-bold text-gray-400 block mb-1">8K M3U URL</label>
                        <div class="flex items-center justify-between bg-white p-1.5 rounded border border-gray-200 cursor-pointer hover:border-brand-900 group/input" onclick="copyString('${lic.m3u_url_8k}')">
                            <input readonly value="${lic.m3u_url_8k}" class="w-full text-[10px] font-mono text-gray-500 bg-transparent outline-none cursor-pointer truncate">
                            <i class="fa-regular fa-copy text-[10px] text-gray-300 group-hover/input:text-brand-900 ml-1"></i>
                        </div>
                    </div>` : ''}
                    
                     ${lic.epgenius_url ? `
                    <div>
                        <label class="text-[9px] uppercase font-bold text-blue-400 block mb-1">EPGenius Playlist URL</label>
                        <div class="flex items-center justify-between bg-white p-1.5 rounded border border-blue-100 cursor-pointer hover:border-blue-500 group/input" onclick="copyString('${lic.epgenius_url}')">
                            <input readonly value="${lic.epgenius_url}" class="w-full text-[10px] font-mono text-gray-500 bg-transparent outline-none cursor-pointer truncate">
                            <i class="fa-regular fa-copy text-[10px] text-gray-300 group-hover/input:text-blue-500 ml-1"></i>
                        </div>
                    </div>` : ''}
                </div>
            </div>`;
        }

        // --- PRODUCT / ORDER LOGIC ---

        function renderProductGrid() {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            
            products.forEach(p => {
                // Determine icon based on product name keywords
                let icon = 'fa-box-open';
                if(p.name.toLowerCase().includes('month')) icon = 'fa-calendar-check';
                if(p.name.toLowerCase().includes('year')) icon = 'fa-crown';
                if(p.name.toLowerCase().includes('donate')) icon = 'fa-heart';

                const html = `
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-transparent hover:border-brand-900 transition flex flex-col h-full relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition"><i class="fa-solid ${icon} text-6xl"></i></div>
                    
                    <div class="flex-1 mb-4 relative z-10">
                        <h4 class="font-bold text-lg text-brand-900 leading-tight mb-2">${p.name}</h4>
                        <div class="text-2xl font-bold text-gray-900">${CONFIG.CURRENCY_SYMBOL}${p.price}</div>
                        ${p.credits ? `<div class="text-xs text-gray-400 mt-1">${p.credits} Credits Value</div>` : ''}
                    </div>
                    
                    <button onclick="openPurchaseModal('${p.name}', '${p.price}')" class="w-full py-3 rounded-xl bg-gray-100 text-brand-900 font-bold hover:bg-brand-900 hover:text-white transition relative z-10">
                        Purchase
                    </button>
                </div>`;
                grid.innerHTML += html;
            });
        }

        window.openPurchaseModal = (name, price) => {
            document.getElementById('modal-product-name').textContent = name;
            document.getElementById('modal-product-price').textContent = `${CONFIG.CURRENCY_SYMBOL}${price}`;
            
            // Build Mailto Link
            const subject = encodeURIComponent(`Payment Sent: ${name} (${currentUserData.email})`);
            const body = encodeURIComponent(`Hi Elliot,\n\nI have sent an e-transfer of $${price} for the ${name} package.\n\nAccount Email: ${currentUserData.email}\n\nThanks!`);
            document.getElementById('notify-link').href = `mailto:e.chinerman@gmail.com?subject=${subject}&body=${body}`;
            
            document.getElementById('purchase-modal').classList.remove('hidden');
        };

        // --- DEVICE INVENTORY (NEW WIDGET) ---

        function renderConfigUI() {
            // Live/VOD Tags
            const renderTags = (containerId, selectedList, allOptions, type) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                selectedList.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'bg-brand-900 text-white px-3 py-1 rounded-full text-[10px] font-bold flex items-center gap-2 hover:bg-red-600 transition';
                    btn.innerHTML = `${item} <i class="fa-solid fa-times"></i>`;
                    btn.onclick = () => togglePref(type, item);
                    container.appendChild(btn);
                });

                const select = document.getElementById(type === 'live' ? 'live-pref-select' : 'vod-pref-select');
                select.innerHTML = `<option value="">+ Add...</option>`;
                allOptions.forEach(opt => {
                    if(!selectedList.includes(opt)) {
                        const o = document.createElement('option');
                        o.value = opt;
                        o.textContent = opt;
                        select.appendChild(o);
                    }
                });
            };

            renderTags('live-tags', currentUserData.live_preferences || [], contentOptions.live_list || [], 'live');
            renderTags('vod-tags', currentUserData.vod_preferences || [], contentOptions.vod_list || [], 'vod');
            
            // Event listeners for dropdowns
            document.getElementById('live-pref-select').onchange = (e) => { if(e.target.value) togglePref('live', e.target.value); };
            document.getElementById('vod-pref-select').onchange = (e) => { if(e.target.value) togglePref('vod', e.target.value); };

            // Custom Request
            document.getElementById('custom-req').value = currentUserData.custom_request || '';

            // Render Device Grid
            renderDeviceGrid();
        }

        function renderDeviceGrid() {
            const grid = document.getElementById('device-grid');
            grid.innerHTML = '';
            
            // Devices stored as strings in array: "Name|Type" or just "Name" (Legacy)
            // We need to parse or handle objects. 
            // Current DB schema is array of strings. 
            // Let's stick to strings for schema compatibility but try to detect type or use delimiter.
            // PROPOSAL: Store as "Type|Name" string to avoid object migration? 
            // OR simply stick to "Name" and guess icon, or just generic icon.
            // User requested "Options to choose from".
            // Let's store as objects in UI state but save as strings "Name (Type)" for simplicity in DB if schema is strict array of strings.
            
            const userDevices = currentUserData?.devices || [];
            
            userDevices.forEach(devStr => {
                // Parse "Name (Type)" or just "Name"
                let name = devStr;
                let type = 'tv'; // Default
                let icon = 'fa-tv';

                if(devStr.includes('ðŸ“±')) { type = 'mobile'; icon = 'fa-mobile-screen'; name = devStr.replace('ðŸ“± ', ''); }
                else if(devStr.includes('ðŸ“¦')) { type = 'box'; icon = 'fa-box'; name = devStr.replace('ðŸ“¦ ', ''); }
                else if(devStr.includes('ðŸ’»')) { type = 'laptop'; icon = 'fa-laptop'; name = devStr.replace('ðŸ’» ', ''); }
                else if(devStr.includes('ðŸ“º')) { type = 'tv'; icon = 'fa-tv'; name = devStr.replace('ðŸ“º ', ''); }

                const el = document.createElement('div');
                el.className = 'bg-gray-50 p-3 rounded-xl flex items-center justify-between group border border-transparent hover:border-gray-200 transition';
                el.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="text-gray-400 text-sm"><i class="fa-solid ${icon}"></i></div>
                        <span class="text-xs font-bold text-gray-700 truncate">${name}</span>
                    </div>
                    <button onclick="removeDevice('${devStr}')" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-times"></i></button>
                `;
                grid.appendChild(el);
            });
        }

        document.getElementById('add-device-btn').addEventListener('click', async () => {
            const name = document.getElementById('new-device-name').value;
            const type = document.getElementById('new-device-type').value;
            
            if(!name) return;

            // Encode type into string for storage (Simple approach)
            let emoji = 'ðŸ“º';
            if(type === 'mobile') emoji = 'ðŸ“±';
            if(type === 'box') emoji = 'ðŸ“¦';
            if(type === 'laptop') emoji = 'ðŸ’»';

            const val = `${emoji} ${name}`;

            const userRef = doc(db, 'users', auth.currentUser.uid);
            await updateDoc(userRef, { devices: arrayUnion(val) });
            
            if(!currentUserData.devices) currentUserData.devices = [];
            currentUserData.devices.push(val);
            
            document.getElementById('new-device-name').value = ''; // Reset input
            renderDeviceGrid();
            showToast('Device added');
        });

        window.removeDevice = async (device) => {
            const userRef = doc(db, 'users', auth.currentUser.uid);
            await updateDoc(userRef, { devices: arrayRemove(device) });
            currentUserData.devices = currentUserData.devices.filter(d => d !== device);
            renderDeviceGrid();
            showToast('Device removed');
        };

        window.togglePref = async (type, val) => {
            const field = type === 'live' ? 'live_preferences' : 'vod_preferences';
            let list = currentUserData[field] || [];
            
            if(list.includes(val)) list = list.filter(i => i !== val);
            else list.push(val);

            currentUserData[field] = list;
            renderConfigUI(); // Optimistic UI update
        };

        document.getElementById('save-config-btn').addEventListener('click', async () => {
            const userRef = doc(db, 'users', auth.currentUser.uid);
            await updateDoc(userRef, {
                live_preferences: currentUserData.live_preferences || [],
                vod_preferences: currentUserData.vod_preferences || [],
                custom_request: document.getElementById('custom-req').value
            });
            showToast('Preferences Saved');
        });

        // --- AUTH & MIGRATION ---

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                showToast(err.message);
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('reg-code').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;

            if (code !== CONFIG.INVITE_CODE) {
                showToast("Invalid Invite Code");
                return;
            }

            try {
                const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCred.user;

                // MIGRATION LOGIC
                const q = query(collection(db, "users"), where("email", "==", email));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const oldDoc = querySnapshot.docs[0];
                    const oldData = oldDoc.data();
                    
                    await runTransaction(db, async (transaction) => {
                        const newDocRef = doc(db, "users", user.uid);
                        const oldDocRef = doc(db, "users", oldDoc.id);
                        transaction.set(newDocRef, oldData);
                        transaction.delete(oldDocRef);
                    });
                    showToast('Account claimed successfully!');
                } else {
                    await setDoc(doc(db, "users", user.uid), {
                        email: email,
                        status: "Pending",
                        created_at: new Date().toISOString(),
                        devices: [],
                        licenses: [], 
                        live_preferences: ["Elliot's Default (QC + Sports + English)"], 
                        vod_preferences: ["Elliot's Default (Movies & Series)"], 
                        custom_request: "",
                        credits_allocated: 0
                    });
                    showToast('Account created successfully!');
                }
            } catch (err) {
                console.error(err);
                showToast(err.message);
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
    </script>
</body>
</html>
