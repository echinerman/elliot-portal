<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>goelliot.vip | Private Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fafaf9; color: #292524; }
        .hidden { display: none; }
        .btn { transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
    </style>
</head>
<body class="antialiased">

    <!-- NAV -->
    <nav class="bg-white border-b border-stone-200 sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 h-16 flex justify-between items-center">
            <span class="font-bold text-xl tracking-tight">goelliot.vip</span>
            <button id="logout-btn" onclick="Auth.logout()" class="hidden text-sm text-red-600 hover:text-red-800 font-medium">Sign Out</button>
        </div>
    </nav>

    <!-- VIEW: LOGIN / REGISTER -->
    <div id="view-auth" class="min-h-[80vh] flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border border-stone-100 overflow-hidden">
            <div class="flex border-b border-stone-100">
                <button onclick="toggleAuth('login')" id="tab-login" class="flex-1 py-4 text-sm font-bold bg-stone-50 text-stone-400">Log In</button>
                <button onclick="toggleAuth('register')" id="tab-register" class="flex-1 py-4 text-sm font-bold bg-white text-stone-900 border-t-2 border-stone-900">Register</button>
            </div>
            
            <div class="p-8">
                <!-- Login Form -->
                <form id="form-login" class="hidden space-y-4" onsubmit="Auth.login(event)">
                    <div><label class="text-xs font-bold uppercase text-stone-400">Email</label><input type="email" id="l-email" class="w-full border rounded-lg p-3 outline-none focus:ring-2 focus:ring-stone-900" required></div>
                    <div><label class="text-xs font-bold uppercase text-stone-400">Password</label><input type="password" id="l-pass" class="w-full border rounded-lg p-3 outline-none focus:ring-2 focus:ring-stone-900" required></div>
                    <button type="submit" class="w-full bg-stone-900 text-white font-bold py-3 rounded-lg hover:bg-stone-700 btn">Enter Portal</button>
                </form>

                <!-- Register Form -->
                <form id="form-register" class="space-y-4" onsubmit="Auth.register(event)">
                    <div><label class="text-xs font-bold uppercase text-stone-400">Invite Code</label><input type="text" id="r-code" class="w-full border rounded-lg p-3 outline-none focus:ring-2 focus:ring-stone-900 uppercase tracking-widest" required></div>
                    <div><label class="text-xs font-bold uppercase text-stone-400">Email</label><input type="email" id="r-email" class="w-full border rounded-lg p-3 outline-none focus:ring-2 focus:ring-stone-900" required></div>
                    <div><label class="text-xs font-bold uppercase text-stone-400">Create Password</label><input type="password" id="r-pass" class="w-full border rounded-lg p-3 outline-none focus:ring-2 focus:ring-stone-900" required minlength="6"></div>
                    <button type="submit" class="w-full bg-stone-900 text-white font-bold py-3 rounded-lg hover:bg-stone-700 btn">Create Account</button>
                </form>
                <p id="auth-error" class="text-red-500 text-center text-sm mt-4 hidden"></p>
            </div>
        </div>
    </div>

    <!-- VIEW: DASHBOARD -->
    <div id="view-dashboard" class="hidden max-w-4xl mx-auto p-4 py-8 space-y-8">
        
        <!-- Welcome -->
        <div>
            <h1 class="text-3xl font-bold text-stone-900">My Dashboard</h1>
            <p class="text-stone-500" id="dash-email">...</p>
        </div>

        <!-- Status Card -->
        <div class="bg-stone-900 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-stone-800 rounded-full -mr-10 -mt-10 opacity-50"></div>
            <div class="relative z-10 flex justify-between items-start">
                <div>
                    <p class="text-stone-400 text-xs font-bold uppercase tracking-wider mb-1">Account Status</p>
                    <div class="flex items-center gap-2"><div class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse"></div><span class="text-xl font-bold" id="dash-status">Active</span></div>
                </div>
                <div class="text-right">
                    <p class="text-stone-400 text-xs font-bold uppercase tracking-wider mb-1">Expires On</p>
                    <p class="text-xl font-mono" id="dash-expiry">---</p>
                </div>
            </div>
        </div>

        <!-- Warning Blocks -->
        <div id="msg-disabled" class="hidden bg-red-50 border border-red-200 text-red-800 p-4 rounded-xl text-center font-bold">
            <i class="fas fa-ban mr-2"></i> Account Disabled. Please contact Elliot.
        </div>
        <div id="msg-pending" class="hidden bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-xl text-center">
            <i class="fas fa-clock mr-2"></i> Activation Pending. Check back shortly.
        </div>

        <!-- Credentials (Hidden if disabled/pending) -->
        <div id="dash-content" class="space-y-8 hidden">
            
            <!-- Connection Details -->
            <div class="bg-white p-6 rounded-2xl border border-stone-200 shadow-sm">
                <h2 class="text-xl font-bold text-stone-900 mb-6">Connection Details</h2>
                
                <!-- EPGenius -->
                <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 mb-6">
                    <h3 class="font-bold text-blue-900 text-sm mb-1"><i class="fas fa-star mr-2"></i>Recommended: EPGenius</h3>
                    <p class="text-xs text-blue-700 mb-3">Use this M3U URL. It includes the EPG automatically.</p>
                    <div class="flex bg-white rounded border border-blue-200 p-1">
                        <input id="dash-epgenius" readonly class="flex-1 px-2 text-xs font-mono outline-none text-stone-600 bg-transparent" value="...">
                        <button onclick="copy('dash-epgenius')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">Copy</button>
                    </div>
                </div>

                <!-- Credentials -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div><label class="text-xs font-bold text-stone-400 uppercase">Server URL</label><div class="flex bg-stone-50 border rounded p-1"><code id="dash-server" class="flex-1 px-2 text-sm">...</code></div></div>
                    <div><label class="text-xs font-bold text-stone-400 uppercase">Username</label><div class="flex bg-stone-50 border rounded p-1"><code id="dash-user" class="flex-1 px-2 text-sm">...</code></div></div>
                    <div><label class="text-xs font-bold text-stone-400 uppercase">Password</label><div class="flex bg-stone-50 border rounded p-1"><code id="dash-pass" class="flex-1 px-2 text-sm">...</code></div></div>
                </div>

                <!-- Backup -->
                <details class="text-xs text-stone-400 cursor-pointer">
                    <summary>Show Backup / Raw M3U</summary>
                    <div class="mt-2 flex bg-stone-50 border rounded p-1"><input id="dash-m3u" readonly class="flex-1 px-2 bg-transparent outline-none" value="..."><button onclick="copy('dash-m3u')" class="bg-stone-200 px-3 rounded text-stone-600">Copy</button></div>
                </details>
            </div>

            <!-- Pricing & Contact -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl border border-stone-200 shadow-sm">
                    <h3 class="font-bold text-stone-900 mb-4">Pricing</h3>
                    <div class="space-y-2 text-sm text-stone-600 font-mono">
                        <div class="flex justify-between border-b pb-1"><span>1 Month</span><span>$10</span></div>
                        <div class="flex justify-between border-b pb-1"><span>3 Months</span><span>$25</span></div>
                        <div class="flex justify-between border-b pb-1"><span>6 Months</span><span>$40</span></div>
                        <div class="flex justify-between font-bold"><span>1 Year</span><span>$60</span></div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-2xl border border-stone-200 shadow-sm flex flex-col justify-center gap-3">
                    <button onclick="contact('Renewal')" class="w-full bg-stone-900 text-white font-bold py-3 rounded-xl hover:bg-stone-700 btn"><i class="fab fa-facebook-messenger mr-2"></i> Request Renewal</button>
                    <button onclick="contact('Support')" class="w-full bg-white border border-stone-300 text-stone-700 font-bold py-3 rounded-xl hover:bg-stone-50 btn">Contact Support</button>
                </div>
            </div>

            <!-- Simplified Requests -->
            <div class="bg-white p-6 rounded-2xl border border-stone-200 shadow-sm">
                <h3 class="font-bold text-stone-900 mb-2">Special Requests</h3>
                <p class="text-sm text-stone-500 mb-4">Elliot's default playlist includes all English & French channels. Need something specific? Type it here.</p>
                <textarea id="user-notes" rows="2" class="w-full border rounded-lg p-3 text-sm mb-3 outline-none focus:ring-1 focus:ring-stone-400" placeholder="e.g. Add Italian channels, Remove Kids section..."></textarea>
                <button onclick="saveNotes()" class="bg-stone-200 text-stone-700 px-4 py-2 rounded-lg text-sm font-bold hover:bg-stone-300 btn">Save Note</button>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import CONFIG from './config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const app = initializeApp(CONFIG.FIREBASE);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTH ---
        window.Auth = {
            login: async (e) => {
                e.preventDefault();
                try {
                    await signInWithEmailAndPassword(auth, document.getElementById('l-email').value, document.getElementById('l-pass').value);
                } catch(err) { document.getElementById('auth-error').innerText = "Invalid credentials."; document.getElementById('auth-error').classList.remove('hidden'); }
            },
            register: async (e) => {
                e.preventDefault();
                if(document.getElementById('r-code').value.toUpperCase() !== CONFIG.INVITE_CODE) return alert("Invalid Invite Code");
                try {
                    const cred = await createUserWithEmailAndPassword(auth, document.getElementById('r-email').value, document.getElementById('r-pass').value);
                    // Create minimal user doc
                    await setDoc(doc(db, "users", cred.user.uid), {
                        email: cred.user.email.toLowerCase(),
                        status: "Pending",
                        created: new Date().toISOString()
                    });
                } catch(err) { alert(err.message); }
            },
            logout: () => signOut(auth)
        };

        // --- UI LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Logged In
                document.getElementById('view-auth').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('dash-email').innerText = user.email;
                await loadData(user.uid);
            } else {
                // Logged Out
                document.getElementById('view-auth').classList.remove('hidden');
                document.getElementById('view-dashboard').classList.add('hidden');
                document.getElementById('logout-btn').classList.add('hidden');
            }
        });

        async function loadData(uid) {
            try {
                const snap = await getDoc(doc(db, "users", uid));
                if (snap.exists()) {
                    const d = snap.data();
                    
                    // 1. Status Check
                    if (d.deleted) {
                        document.getElementById('msg-disabled').classList.remove('hidden');
                        document.getElementById('dash-status').innerText = "Disabled";
                        document.getElementById('dash-status').parentElement.className = "flex items-center gap-2 text-red-500";
                        return;
                    }
                    if (d.status === "Pending") {
                        document.getElementById('msg-pending').classList.remove('hidden');
                        document.getElementById('dash-status').innerText = "Pending";
                        return;
                    }

                    // 2. Active - Show Data
                    document.getElementById('dash-content').classList.remove('hidden');
                    document.getElementById('dash-expiry').innerText = d.expiry || '---';
                    
                    // Credentials
                    document.getElementById('dash-server').innerText = d.serverUrl || '---';
                    document.getElementById('dash-user').innerText = d.username || '---';
                    document.getElementById('dash-pass').innerText = d.password || '---';
                    document.getElementById('dash-epgenius').value = d.epgeniusM3u || '';
                    document.getElementById('dash-m3u').value = d.m3uUrl || '';
                    document.getElementById('user-notes').value = d.notes || '';
                }
            } catch(e) { console.error(e); }
        }

        window.toggleAuth = (tab) => {
            document.getElementById('form-login').classList.toggle('hidden', tab !== 'login');
            document.getElementById('form-register').classList.toggle('hidden', tab !== 'register');
            // Toggle visual tabs
            const tLogin = document.getElementById('tab-login');
            const tReg = document.getElementById('tab-register');
            if(tab === 'login') {
                tLogin.className = "flex-1 py-4 text-sm font-bold bg-white text-stone-900 border-t-2 border-stone-900";
                tReg.className = "flex-1 py-4 text-sm font-bold bg-stone-50 text-stone-400";
            } else {
                tReg.className = "flex-1 py-4 text-sm font-bold bg-white text-stone-900 border-t-2 border-stone-900";
                tLogin.className = "flex-1 py-4 text-sm font-bold bg-stone-50 text-stone-400";
            }
        };

        window.saveNotes = async () => {
            const notes = document.getElementById('user-notes').value;
            await updateDoc(doc(db, "users", auth.currentUser.uid), { notes });
            alert("Note saved sent to Elliot.");
        };

        window.copy = (id) => {
            const el = document.getElementById(id);
            el.select();
            document.execCommand('copy');
            alert("Copied!");
        };

        window.contact = (subject) => {
            window.open(`${CONFIG.FB_LINK}?text=Hi Elliot, regarding ${subject}...`, '_blank');
        };
    </script>
</body>
</html>


