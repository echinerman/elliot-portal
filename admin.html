<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { brand: { 800: '#292524', 900: '#1c1917' } } }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800">

    <!-- Navbar -->
    <nav class="bg-brand-900 text-white p-4 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fa-solid fa-shield-halved mr-2"></i>Admin Console</h1>
            <div class="flex gap-4 text-sm">
                <span id="admin-email">Loading...</span>
                <button onclick="window.location.href='index.html'" class="hover:text-gray-300">Exit</button>
            </div>
        </div>
    </nav>

    <div id="main-content" class="max-w-7xl mx-auto p-6 space-y-6 opacity-0 transition-opacity duration-500">
        
        <!-- Financials Row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-blue-500">
                <h3 class="text-xs font-bold text-gray-400 uppercase">Credits Remaining</h3>
                <p class="text-3xl font-bold mt-2" id="stat-credits">--</p>
                <button onclick="openSupplyModal()" class="text-xs text-blue-500 font-bold mt-2 hover:underline">+ Add Supply</button>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-green-500">
                <h3 class="text-xs font-bold text-gray-400 uppercase">Est. Total Profit</h3>
                <p class="text-3xl font-bold mt-2 text-green-600" id="stat-profit">--</p>
                <p class="text-xs text-gray-400 mt-1">*Based on historical supply cost</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-purple-500">
                <h3 class="text-xs font-bold text-gray-400 uppercase">Total Users</h3>
                <p class="text-3xl font-bold mt-2" id="stat-users">--</p>
                <div class="mt-2 text-xs">
                    <span id="stat-active" class="text-green-600 font-bold">0 Active</span> â€¢ 
                    <span id="stat-pending" class="text-yellow-600 font-bold">0 Pending</span>
                </div>
            </div>
        </div>

        <!-- Profit Analysis Table -->
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
            <div class="p-4 border-b border-gray-100">
                <h2 class="font-bold text-lg">Product Unit Economics</h2>
                <p class="text-xs text-gray-400">Profit calculation based on Credit Cost: <span class="font-mono text-brand-900">$3.36 CAD</span></p>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-50">
                        <tr>
                            <th class="px-6 py-3">Product Name</th>
                            <th class="px-6 py-3">Price (CAD)</th>
                            <th class="px-6 py-3">Credits</th>
                            <th class="px-6 py-3">Cost ($3.36/cr)</th>
                            <th class="px-6 py-3">Net Profit</th>
                            <th class="px-6 py-3">Margin</th>
                        </tr>
                    </thead>
                    <tbody id="profit-body" class="divide-y divide-gray-100">
                        <!-- Dynamic Rows -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Roster -->
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h2 class="font-bold text-lg">User Roster</h2>
                <div class="flex gap-2">
                    <input type="text" id="search-input" placeholder="Search email..." class="bg-gray-50 p-2 rounded-lg text-sm outline-none border border-gray-200 focus:border-brand-900">
                    <button onclick="seedData()" class="bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs hover:bg-gray-300">Seed Defaults</button>
                    <button onclick="openUserModal()" class="bg-brand-900 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-brand-800">+ New User</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-50">
                        <tr>
                            <th class="px-6 py-3">User / Email</th>
                            <th class="px-6 py-3">Status</th>
                            <th class="px-6 py-3">Credits/Expiry</th>
                            <th class="px-6 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="roster-body" class="divide-y divide-gray-100">
                        <!-- Dynamic Rows -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- User Modal -->
    <div id="user-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl transform transition-all">
            <h3 class="text-lg font-bold mb-4">Edit / Create User</h3>
            <form id="user-form" class="space-y-4">
                <input type="hidden" id="edit-uid">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Email</label>
                        <input type="email" id="edit-email" class="w-full p-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Status</label>
                        <select id="edit-status" class="w-full p-2 border rounded-lg">
                            <option value="Pending">Pending</option>
                            <option value="Active">Active</option>
                            <option value="Expired">Expired</option>
                            <option value="Banned">Banned</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Expiry Date</label>
                        <input type="date" id="edit-expiry" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Credits Alloc.</label>
                        <input type="number" id="edit-credits" value="0" class="w-full p-2 border rounded-lg">
                    </div>
                </div>
                <div class="bg-gray-50 p-4 rounded-xl space-y-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase">IPTV Credentials</label>
                    <input type="text" id="edit-url" placeholder="Server URL" class="w-full p-2 border rounded-lg text-sm">
                    <div class="flex gap-2">
                        <input type="text" id="edit-user" placeholder="Username" class="w-full p-2 border rounded-lg text-sm">
                        <input type="text" id="edit-pass" placeholder="Password" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                </div>
                <div class="flex justify-between items-center mt-6">
                    <button type="button" onclick="archiveUser()" id="btn-archive" class="text-red-500 text-sm font-bold hover:underline">Archive User</button>
                    <div class="flex gap-2">
                        <button type="button" onclick="closeModal('user-modal')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-brand-900 text-white font-bold rounded-lg hover:bg-brand-800">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Supply Modal -->
    <div id="supply-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Add Supply</h3>
            <form id="supply-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Credits Purchased</label>
                    <input type="number" id="supply-credits" class="w-full p-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Total Cost ($)</label>
                    <input type="number" id="supply-cost" class="w-full p-2 border rounded-lg" required>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeModal('supply-modal')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Add Entry</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { CONFIG } from './config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            setDoc, 
            updateDoc, 
            addDoc,
            arrayUnion,
            query,
            where
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(CONFIG.FIREBASE);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CONSTANTS ---
        const COST_PER_CREDIT = 3.36; // CAD

        let allUsers = [];
        let supplyData = [];
        let products = [];

        // --- AUTH GUARD ---
        onAuthStateChanged(auth, (user) => {
            if (!user || user.email !== CONFIG.ADMIN_EMAIL) {
                window.location.href = 'index.html';
            } else {
                document.getElementById('admin-email').textContent = user.email;
                document.getElementById('main-content').classList.remove('opacity-0');
                loadData();
            }
        });

        // --- DATA LOADING ---
        async function loadData() {
            // 1. Fetch Users
            const userSnap = await getDocs(collection(db, 'users'));
            allUsers = [];
            userSnap.forEach(doc => {
                const data = doc.data();
                if(!data.deleted) allUsers.push({ id: doc.id, ...data });
            });

            // 2. Fetch Supply (Ledger)
            const bizSnap = await getDocs(collection(db, 'business_data'));
            supplyData = [];
            bizSnap.forEach(doc => {
                if(doc.data().supply_log) supplyData.push(...doc.data().supply_log);
            });

            // 3. Fetch Products for Profit Analysis
            const prodSnap = await getDocs(collection(db, 'products'));
            products = [];
            prodSnap.forEach(doc => products.push({id: doc.id, ...doc.data()}));
            
            // Sort products by price
            products.sort((a,b) => a.price - b.price);

            calculateStats();
            renderRoster();
            renderProfitTable();
        }

        function calculateStats() {
            const totalSupply = supplyData.reduce((sum, item) => sum + Number(item.credits), 0);
            const totalCost = supplyData.reduce((sum, item) => sum + Number(item.cost), 0);
            const totalAllocated = allUsers.reduce((sum, u) => sum + (Number(u.credits_allocated) || 0), 0);
            
            // Est. Revenue based on average price (simple assumption of $10/credit)
            // For a more accurate "Total Profit", we'd need to know exactly which packages were sold.
            // Currently using a blended average for the dashboard total.
            const BLENDED_REV_PER_CREDIT = 8; 
            const estRevenue = totalAllocated * BLENDED_REV_PER_CREDIT;

            document.getElementById('stat-credits').textContent = (totalSupply - totalAllocated).toLocaleString();
            document.getElementById('stat-profit').textContent = CONFIG.CURRENCY_SYMBOL + (estRevenue - totalCost).toLocaleString();
            
            document.getElementById('stat-users').textContent = allUsers.length;
            document.getElementById('stat-active').textContent = `${allUsers.filter(u => u.status === 'Active').length} Active`;
            document.getElementById('stat-pending').textContent = `${allUsers.filter(u => u.status === 'Pending').length} Pending`;
        }

        // --- PROFIT TABLE UI ---
        function renderProfitTable() {
            const tbody = document.getElementById('profit-body');
            tbody.innerHTML = '';

            products.forEach(p => {
                const creditCost = p.credits * COST_PER_CREDIT;
                const netProfit = p.price - creditCost;
                const margin = p.price > 0 ? ((netProfit / p.price) * 100).toFixed(1) : 0;
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-6 py-4 font-bold text-gray-900">${p.name}</td>
                    <td class="px-6 py-4">${CONFIG.CURRENCY_SYMBOL}${p.price}</td>
                    <td class="px-6 py-4">${p.credits}</td>
                    <td class="px-6 py-4 text-gray-500">${CONFIG.CURRENCY_SYMBOL}${creditCost.toFixed(2)}</td>
                    <td class="px-6 py-4 font-bold ${netProfit >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${CONFIG.CURRENCY_SYMBOL}${netProfit.toFixed(2)}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-xs font-bold ${margin > 30 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${margin}%
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- ROSTER UI ---
        function renderRoster(filter = "") {
            const tbody = document.getElementById('roster-body');
            tbody.innerHTML = '';
            
            const filtered = allUsers.filter(u => u.email.toLowerCase().includes(filter.toLowerCase()));

            filtered.forEach(u => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition';
                
                let statusColor = 'text-gray-500 bg-gray-100';
                if(u.status === 'Active') statusColor = 'text-green-700 bg-green-100';
                if(u.status === 'Pending') statusColor = 'text-yellow-700 bg-yellow-100';
                if(u.status === 'Expired') statusColor = 'text-red-700 bg-red-100';

                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-bold text-gray-900">${u.email}</div>
                        <div class="text-xs text-gray-400">${u.id.substring(0,8)}...</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${statusColor}">${u.status}</span>
                    </td>
                    <td class="px-6 py-4 text-gray-600">
                        <div>Alloc: ${u.credits_allocated || 0}</div>
                        <div class="text-xs text-gray-400">Exp: ${u.expiry_date || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="editUser('${u.id}')" class="text-brand-900 font-bold hover:underline">Edit</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('search-input').addEventListener('input', (e) => renderRoster(e.target.value));

        // --- ACTIONS ---

        window.openUserModal = () => {
            document.getElementById('user-form').reset();
            document.getElementById('edit-uid').value = ''; 
            document.getElementById('btn-archive').classList.add('hidden');
            document.getElementById('user-modal').classList.remove('hidden');
        };

        window.editUser = (id) => {
            const u = allUsers.find(user => user.id === id);
            if(!u) return;
            document.getElementById('edit-uid').value = u.id;
            document.getElementById('edit-email').value = u.email;
            document.getElementById('edit-status').value = u.status || 'Pending';
            document.getElementById('edit-expiry').value = u.expiry_date || '';
            document.getElementById('edit-credits').value = u.credits_allocated || 0;
            document.getElementById('edit-url').value = u.portal_url || '';
            document.getElementById('edit-user').value = u.username || '';
            document.getElementById('edit-pass').value = u.password || '';
            
            document.getElementById('btn-archive').classList.remove('hidden');
            document.getElementById('user-modal').classList.remove('hidden');
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        document.getElementById('user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const uid = document.getElementById('edit-uid').value;
            const data = {
                email: document.getElementById('edit-email').value,
                status: document.getElementById('edit-status').value,
                expiry_date: document.getElementById('edit-expiry').value,
                credits_allocated: Number(document.getElementById('edit-credits').value),
                portal_url: document.getElementById('edit-url').value,
                username: document.getElementById('edit-user').value,
                password: document.getElementById('edit-pass').value
            };

            try {
                if (uid) {
                    await updateDoc(doc(db, 'users', uid), data);
                } else {
                    // Create NEW user - Initialize with new split categories
                    await addDoc(collection(db, 'users'), { 
                        ...data, 
                        devices: [], 
                        // New fields initialized here for future UI compatibility:
                        live_preferences: ["Elliot's Default (QC + Sports + English)"], 
                        vod_preferences: ["Elliot's Default (Movies & Series)"], 
                        custom_request: "",
                        created_at: new Date().toISOString() 
                    });
                }
                closeModal('user-modal');
                loadData();
            } catch (err) { alert(err.message); }
        });

        window.archiveUser = async () => {
            const uid = document.getElementById('edit-uid').value;
            if(!uid || !confirm('Are you sure? This hides the user from the list.')) return;
            await updateDoc(doc(db, 'users', uid), { deleted: true });
            closeModal('user-modal');
            loadData();
        };

        // --- SUPPLY ACTIONS ---
        window.openSupplyModal = () => document.getElementById('supply-modal').classList.remove('hidden');

        document.getElementById('supply-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const credits = document.getElementById('supply-credits').value;
            const cost = document.getElementById('supply-cost').value;
            
            const ledgerRef = doc(db, 'business_data', 'ledger');
            try {
                await setDoc(ledgerRef, {
                    supply_log: arrayUnion({
                        credits: Number(credits),
                        cost: Number(cost),
                        date: new Date().toISOString()
                    })
                }, { merge: true });
                closeModal('supply-modal');
                loadData();
            } catch (err) { alert(err.message); }
        });

        // --- UTILITY (SEED DATA) ---
        window.seedData = async () => {
            if(!confirm("Warning: This will reset Devices, Categories, and Product Pricing. Continue?")) return;
            
            try {
                // 1. App Config - Devices
                const devices = [
                    'Stick: Amazon Fire TV 4K',
                    'Stick: Chromecast w/ Google TV',
                    'Stick: Roku 4K (Limited)',
                    'Box: Formuler Z11 Pro',
                    'Box: Nvidia Shield Pro',
                    'Box: BuzzTV X5',
                    'Box: MAG 524 (Legacy)',
                    'TV: Samsung Tizen',
                    'TV: LG WebOS',
                    'TV: Android Native (Sony/Hisense)',
                    'Mobile: Android Phone',
                    'Mobile: iPhone (iOS)',
                    'Tablet: iPad',
                    'Tablet: Android Tablet',
                    'PC: Windows',
                    'PC: Mac OS'
                ];
                await setDoc(doc(db, 'app_config', 'devices'), { list: devices });

                // 2. App Config - Content Categories (Live & VOD)
                // Split per request, including "Other" for custom text scenarios
                const live_cats = [
                    "Elliot's Default (QC + Sports + English)",
                    "Quebec Premium (French)",
                    "Canada & USA (English)",
                    "International (Europe/Latino)",
                    "Adult 18+",
                    "Other / Custom Request"
                ];

                const vod_cats = [
                    "Elliot's Default (Movies & Series)",
                    "French Content Only",
                    "English Content Only",
                    "International",
                    "Adult",
                    "None",
                    "Other / Custom Request"
                ];

                // Using a new document 'content_options' to store both lists
                await setDoc(doc(db, 'app_config', 'content_options'), { 
                    live_list: live_cats,
                    vod_list: vod_cats
                });
                
                // 3. Products
                await setDoc(doc(db, 'products', 'demo_1day'), { name: 'Demo (1 Day)', price: 0, credits: 0 });
                await setDoc(doc(db, 'products', '1_month'), { name: '1 Month Access', price: 10, credits: 1 });
                await setDoc(doc(db, 'products', '3_month'), { name: '3 Months Bundle', price: 25, credits: 3 });
                await setDoc(doc(db, 'products', '6_month'), { name: '6 Months Deal', price: 40, credits: 6 });
                await setDoc(doc(db, 'products', '12_month'), { name: '1 Year VIP', price: 60, credits: 12 });
                
                alert("Database Seeded Successfully! Refresh to see changes.");
                loadData();
            } catch (err) {
                console.error(err);
                alert("Error seeding data: " + err.message);
            }
        };
    </script>
</body>
</html>
