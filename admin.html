<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { brand: { 800: '#292524', 900: '#1c1917' } } }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800">

    <!-- Navbar -->
    <nav class="bg-brand-900 text-white p-4 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fa-solid fa-shield-halved mr-2"></i>Admin Console</h1>
            <div class="flex gap-4 text-sm">
                <span id="admin-email">Loading...</span>
                <button onclick="window.location.href='index.html'" class="hover:text-gray-300">Exit</button>
            </div>
        </div>
    </nav>

    <div id="main-content" class="max-w-7xl mx-auto p-6 space-y-6 opacity-0 transition-opacity duration-500">
        
        <!-- Financials Row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-blue-500">
                <h3 class="text-xs font-bold text-gray-400 uppercase">Credits Remaining</h3>
                <p class="text-3xl font-bold mt-2" id="stat-credits">--</p>
                <button onclick="openSupplyModal()" class="text-xs text-blue-500 font-bold mt-2 hover:underline">+ Add Supply</button>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-green-500">
                <h3 class="text-xs font-bold text-gray-400 uppercase">Est. Total Profit</h3>
                <p class="text-3xl font-bold mt-2 text-green-600" id="stat-profit">--</p>
                <p class="text-xs text-gray-400 mt-1">*Based on historical supply cost</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-purple-500">
                <h3 class="text-xs font-bold text-gray-400 uppercase">Total Users</h3>
                <p class="text-3xl font-bold mt-2" id="stat-users">--</p>
                <div class="mt-2 text-xs">
                    <span id="stat-active" class="text-green-600 font-bold">0 Active</span> • 
                    <span id="stat-pending" class="text-yellow-600 font-bold">0 Pending</span>
                </div>
            </div>
        </div>

        <!-- Profit Analysis Table -->
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
            <div class="p-4 border-b border-gray-100">
                <h2 class="font-bold text-lg">Product Unit Economics</h2>
                <p class="text-xs text-gray-400">Profit calculation based on Credit Cost: <span class="font-mono text-brand-900">$3.36 CAD</span></p>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-50">
                        <tr>
                            <th class="px-6 py-3">Product Name</th>
                            <th class="px-6 py-3">Price (CAD)</th>
                            <th class="px-6 py-3">Credits</th>
                            <th class="px-6 py-3">Cost ($3.36/cr)</th>
                            <th class="px-6 py-3">Net Profit</th>
                            <th class="px-6 py-3">Margin</th>
                        </tr>
                    </thead>
                    <tbody id="profit-body" class="divide-y divide-gray-100">
                        <!-- Dynamic Rows -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Roster -->
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h2 class="font-bold text-lg">User Roster</h2>
                <div class="flex gap-2">
                    <input type="text" id="search-input" placeholder="Search name or email..." class="bg-gray-50 p-2 rounded-lg text-sm outline-none border border-gray-200 focus:border-brand-900">
                    <button onclick="seedData()" class="bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs hover:bg-gray-300">Seed Defaults</button>
                    <button onclick="openUserModal()" class="bg-brand-900 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-brand-800">+ New User</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-50">
                        <tr>
                            <th class="px-6 py-3">User</th>
                            <th class="px-6 py-3">Status</th>
                            <th class="px-6 py-3">8K Details</th>
                            <th class="px-6 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="roster-body" class="divide-y divide-gray-100">
                        <!-- Dynamic Rows -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- User Modal (Expanded for Licenses) -->
    <div id="user-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 overflow-y-auto py-10">
        <div class="bg-white rounded-2xl w-full max-w-3xl p-6 shadow-2xl transform transition-all my-auto relative">
            <button onclick="closeModal('user-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-lg font-bold mb-4 border-b pb-2">Edit / Create User</h3>
            
            <form id="user-form" class="space-y-6">
                <input type="hidden" id="edit-uid">
                
                <!-- Section 1: Identity & Global Status -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="col-span-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Status (Master)</label>
                        <select id="edit-status" class="w-full p-2 border rounded-lg text-sm bg-white">
                            <option value="Pending">Pending</option>
                            <option value="Active">Active</option>
                            <option value="Expired">Expired</option>
                            <option value="Banned">Banned</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Full Name</label>
                        <input type="text" id="edit-name" class="w-full p-2 border rounded-lg text-sm bg-gray-50" placeholder="John Doe">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label>
                        <input type="email" id="edit-email" class="w-full p-2 border rounded-lg text-sm bg-gray-50" required>
                    </div>
                </div>

                <!-- Section 2: Global Configuration -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Global 8K Domain</label>
                        <input type="text" id="edit-domain-8k" placeholder="http://domain.com:port" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Credits Allocated</label>
                        <input type="number" id="edit-credits" value="0" class="w-full p-2 border rounded-lg text-sm bg-white">
                    </div>
                </div>

                <!-- Section 3: License Manager (NEW) -->
                <div class="bg-brand-50 p-4 rounded-xl space-y-4 border border-brand-100">
                    <div class="flex justify-between items-center">
                        <h4 class="text-xs font-bold text-brand-900 uppercase flex items-center gap-2">
                            <i class="fa-solid fa-server"></i> License Manager
                        </h4>
                        <span class="text-[10px] text-gray-500 uppercase font-bold">Manage multiple lines</span>
                    </div>

                    <!-- Licenses List -->
                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-gray-50 text-gray-400 uppercase font-bold">
                                <tr>
                                    <th class="p-2">Label</th>
                                    <th class="p-2">Username</th>
                                    <th class="p-2">Password</th>
                                    <th class="p-2">Expiry</th>
                                    <th class="p-2 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="license-list-body" class="divide-y divide-gray-100">
                                <!-- Dynamic Rows -->
                            </tbody>
                        </table>
                        <div id="no-licenses-msg" class="p-4 text-center text-gray-400 text-sm italic hidden">No active licenses.</div>
                    </div>

                    <!-- Add License Form -->
                    <div class="bg-gray-100 p-3 rounded-lg grid grid-cols-1 md:grid-cols-5 gap-2 items-end">
                        <div class="md:col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase">Label (Device)</label>
                            <input type="text" id="new-lic-label" placeholder="Living Room" class="w-full p-1.5 border rounded text-xs">
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase">Username</label>
                            <input type="text" id="new-lic-user" placeholder="user_123" class="w-full p-1.5 border rounded text-xs">
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase">Password</label>
                            <input type="text" id="new-lic-pass" placeholder="pass_123" class="w-full p-1.5 border rounded text-xs">
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase">Expiry Date</label>
                            <input type="date" id="new-lic-expiry" class="w-full p-1.5 border rounded text-xs">
                        </div>
                        <div class="md:col-span-1">
                            <button type="button" onclick="addLicense()" class="w-full bg-brand-900 text-white text-xs font-bold py-2 rounded hover:bg-brand-800">
                                <i class="fa-solid fa-plus mr-1"></i> Add Line
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section 4: URLs & EPGenius -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Global M3U / EPG URLs</label>
                        <input type="text" id="edit-m3u-8k" placeholder="M3U URL" class="w-full p-2 border rounded-lg text-sm font-mono text-xs">
                        <input type="text" id="edit-epg-8k" placeholder="EPG URL" class="w-full p-2 border rounded-lg text-sm font-mono text-xs">
                    </div>
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 space-y-2">
                        <h4 class="text-xs font-bold text-blue-900 uppercase flex items-center gap-2"><i class="fa-solid fa-bolt"></i> EPGenius</h4>
                        <div class="grid grid-cols-3 gap-2">
                            <input type="number" id="edit-epg-key" placeholder="Key #" class="col-span-1 w-full p-2 border rounded-lg text-sm">
                            <input type="text" id="edit-epg-drive" placeholder="GDrive URL" class="col-span-2 w-full p-2 border rounded-lg text-sm font-mono text-xs">
                        </div>
                    </div>
                </div>

                <!-- Section 5: Preferences & Notes -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Internal Notes</label>
                        <textarea id="edit-notes" rows="3" class="w-full p-2 border rounded-lg text-sm bg-yellow-50 focus:bg-white transition" placeholder="Private admin notes..."></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Selections (Read Only)</label>
                        <div class="p-2 bg-gray-100 rounded-lg text-xs text-gray-600 h-20 overflow-y-auto" id="read-selections"></div>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="flex justify-between items-center pt-4 border-t">
                    <button type="button" onclick="archiveUser()" id="btn-archive" class="text-red-500 text-sm font-bold hover:underline">Archive User</button>
                    <div class="flex gap-2">
                        <button type="button" onclick="closeModal('user-modal')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-brand-900 text-white font-bold rounded-lg hover:bg-brand-800 shadow-lg">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Supply Modal -->
    <div id="supply-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Add Supply</h3>
            <form id="supply-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Credits Purchased</label>
                    <input type="number" id="supply-credits" class="w-full p-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Total Cost ($)</label>
                    <input type="number" id="supply-cost" class="w-full p-2 border rounded-lg" required>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeModal('supply-modal')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Add Entry</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { CONFIG } from './config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            setDoc, 
            updateDoc, 
            addDoc,
            arrayUnion,
            query,
            where
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(CONFIG.FIREBASE);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CONSTANTS ---
        const COST_PER_CREDIT = 3.36; // CAD

        let allUsers = [];
        let supplyData = [];
        let products = [];
        let currentLicenses = []; // Global state for modal

        // --- AUTH GUARD ---
        onAuthStateChanged(auth, (user) => {
            if (!user || user.email !== CONFIG.ADMIN_EMAIL) {
                window.location.href = 'index.html';
            } else {
                document.getElementById('admin-email').textContent = user.email;
                document.getElementById('main-content').classList.remove('opacity-0');
                loadData();
            }
        });

        // --- DATA LOADING ---
        async function loadData() {
            // 1. Fetch Users
            const userSnap = await getDocs(collection(db, 'users'));
            allUsers = [];
            userSnap.forEach(doc => {
                const data = doc.data();
                if(!data.deleted) allUsers.push({ id: doc.id, ...data });
            });

            // 2. Fetch Supply (Ledger)
            const bizSnap = await getDocs(collection(db, 'business_data'));
            supplyData = [];
            bizSnap.forEach(doc => {
                if(doc.data().supply_log) supplyData.push(...doc.data().supply_log);
            });

            // 3. Fetch Products for Profit Analysis
            const prodSnap = await getDocs(collection(db, 'products'));
            products = [];
            prodSnap.forEach(doc => products.push({id: doc.id, ...doc.data()}));
            products.sort((a,b) => a.price - b.price);

            calculateStats();
            renderRoster();
            renderProfitTable();
        }

        function calculateStats() {
            const totalSupply = supplyData.reduce((sum, item) => sum + Number(item.credits), 0);
            const totalCost = supplyData.reduce((sum, item) => sum + Number(item.cost), 0);
            const totalAllocated = allUsers.reduce((sum, u) => sum + (Number(u.credits_allocated) || 0), 0);
            const BLENDED_REV_PER_CREDIT = 8; 
            const estRevenue = totalAllocated * BLENDED_REV_PER_CREDIT;

            document.getElementById('stat-credits').textContent = (totalSupply - totalAllocated).toLocaleString();
            document.getElementById('stat-profit').textContent = CONFIG.CURRENCY_SYMBOL + (estRevenue - totalCost).toLocaleString();
            document.getElementById('stat-users').textContent = allUsers.length;
            document.getElementById('stat-active').textContent = `${allUsers.filter(u => u.status === 'Active').length} Active`;
            document.getElementById('stat-pending').textContent = `${allUsers.filter(u => u.status === 'Pending').length} Pending`;
        }

        // --- PROFIT TABLE UI ---
        function renderProfitTable() {
            const tbody = document.getElementById('profit-body');
            tbody.innerHTML = '';
            products.forEach(p => {
                const creditCost = p.credits * COST_PER_CREDIT;
                const netProfit = p.price - creditCost;
                const margin = p.price > 0 ? ((netProfit / p.price) * 100).toFixed(1) : 0;
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-6 py-4 font-bold text-gray-900">${p.name}</td>
                    <td class="px-6 py-4">${CONFIG.CURRENCY_SYMBOL}${p.price}</td>
                    <td class="px-6 py-4">${p.credits}</td>
                    <td class="px-6 py-4 text-gray-500">${CONFIG.CURRENCY_SYMBOL}${creditCost.toFixed(2)}</td>
                    <td class="px-6 py-4 font-bold ${netProfit >= 0 ? 'text-green-600' : 'text-red-600'}">${CONFIG.CURRENCY_SYMBOL}${netProfit.toFixed(2)}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${margin > 30 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${margin}%</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- ROSTER UI ---
        function renderRoster(filter = "") {
            const tbody = document.getElementById('roster-body');
            tbody.innerHTML = '';
            const filtered = allUsers.filter(u => 
                (u.email && u.email.toLowerCase().includes(filter.toLowerCase())) || 
                (u.full_name && u.full_name.toLowerCase().includes(filter.toLowerCase()))
            );

            filtered.forEach(u => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition';
                
                let statusColor = 'text-gray-500 bg-gray-100';
                if(u.status === 'Active') statusColor = 'text-green-700 bg-green-100';
                if(u.status === 'Pending') statusColor = 'text-yellow-700 bg-yellow-100';
                if(u.status === 'Expired') statusColor = 'text-red-700 bg-red-100';

                // Check licenses count
                const licCount = u.licenses ? u.licenses.length : (u.username_8k ? 1 : 0);
                
                // Expiry Logic: Find latest expiry date from licenses
                let expiryDisplay = 'N/A';
                if (u.licenses && u.licenses.length > 0) {
                    const dates = u.licenses.map(l => l.expiry_date).sort();
                    expiryDisplay = dates[dates.length-1]; // Latest date
                } else if (u.expiry_date) {
                    expiryDisplay = u.expiry_date; // Legacy fallback
                }

                // Icons
                const has8K = licCount > 0 ? `<span class="text-brand-900 font-bold text-xs"><i class="fa-solid fa-server mr-1"></i>${licCount} Line(s)</span>` : '';
                const hasEPG = u.epgenius_key ? '<i class="fa-solid fa-bolt text-blue-600 mr-1" title="EPGenius"></i>' : '';
                const hasNotes = u.internal_notes ? '<i class="fa-regular fa-note-sticky text-yellow-500" title="Notes"></i>' : '';

                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-bold text-gray-900">${u.full_name || 'No Name'}</div>
                        <div class="text-xs text-gray-500">${u.email}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${statusColor}">${u.status}</span>
                    </td>
                    <td class="px-6 py-4 text-gray-600">
                        <div class="flex items-center gap-2 mb-1">${has8K} ${hasEPG} ${hasNotes}</div>
                        <div class="text-xs">
                            <span class="font-bold">Exp:</span> ${expiryDisplay}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="editUser('${u.id}')" class="text-brand-900 font-bold hover:underline">Edit</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        document.getElementById('search-input').addEventListener('input', (e) => renderRoster(e.target.value));

        // --- LICENSE MANAGER LOGIC ---

        window.renderLicenseList = () => {
            const tbody = document.getElementById('license-list-body');
            tbody.innerHTML = '';
            if (currentLicenses.length === 0) {
                document.getElementById('no-licenses-msg').classList.remove('hidden');
                return;
            }
            document.getElementById('no-licenses-msg').classList.add('hidden');

            currentLicenses.forEach((lic, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-100 hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="p-2 font-medium">${lic.label || 'Main'}</td>
                    <td class="p-2 text-gray-600">${lic.username_8k}</td>
                    <td class="p-2 font-mono text-gray-500">••••</td>
                    <td class="p-2 text-gray-600">${lic.expiry_date}</td>
                    <td class="p-2 text-right">
                        <button type="button" onclick="removeLicense(${index})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.addLicense = () => {
            const label = document.getElementById('new-lic-label').value;
            const user = document.getElementById('new-lic-user').value;
            const pass = document.getElementById('new-lic-pass').value;
            const expiry = document.getElementById('new-lic-expiry').value;

            if(!user || !pass || !expiry) {
                alert("Username, Password, and Expiry are required.");
                return;
            }

            currentLicenses.push({
                id: crypto.randomUUID(),
                label: label || 'Line ' + (currentLicenses.length + 1),
                username_8k: user,
                password_8k: pass,
                expiry_date: expiry,
                status: 'Active'
            });

            // Clear inputs
            document.getElementById('new-lic-label').value = '';
            document.getElementById('new-lic-user').value = '';
            document.getElementById('new-lic-pass').value = '';
            document.getElementById('new-lic-expiry').value = '';

            window.renderLicenseList();
        };

        window.removeLicense = (index) => {
            currentLicenses.splice(index, 1);
            window.renderLicenseList();
        };

        // --- ACTIONS ---

        window.openUserModal = () => {
            document.getElementById('user-form').reset();
            document.getElementById('edit-uid').value = ''; 
            document.getElementById('read-selections').innerHTML = '<span class="italic text-gray-400">New user</span>';
            document.getElementById('btn-archive').classList.add('hidden');
            
            // Reset Licenses
            currentLicenses = [];
            window.renderLicenseList();
            
            document.getElementById('user-modal').classList.remove('hidden');
        };

        window.editUser = (id) => {
            const u = allUsers.find(user => user.id === id);
            if(!u) return;
            
            // Basic
            document.getElementById('edit-uid').value = u.id;
            document.getElementById('edit-name').value = u.full_name || '';
            document.getElementById('edit-email').value = u.email;
            document.getElementById('edit-status').value = u.status || 'Pending';
            document.getElementById('edit-credits').value = u.credits_allocated || 0;
            
            // Global 8K Details
            document.getElementById('edit-domain-8k').value = u.domain_8k || '';
            document.getElementById('edit-m3u-8k').value = u.m3u_url_8k || '';
            document.getElementById('edit-epg-8k').value = u.epg_url_8k || '';

            // EPGenius
            document.getElementById('edit-epg-key').value = u.epgenius_key || '';
            document.getElementById('edit-epg-drive').value = u.epgenius_url || '';

            // Notes
            document.getElementById('edit-notes').value = u.internal_notes || '';

            // --- LICENSE MIGRATION & LOADING ---
            currentLicenses = u.licenses || [];
            
            // Legacy Migration: If no licenses array but singular fields exist, convert to license
            if (currentLicenses.length === 0 && u.username_8k) {
                currentLicenses.push({
                    id: crypto.randomUUID(),
                    label: "Primary (Legacy)",
                    username_8k: u.username_8k,
                    password_8k: u.password_8k,
                    expiry_date: u.expiry_date || '',
                    status: 'Active'
                });
            }
            window.renderLicenseList();

            // Read Only Selections
            const devices = (u.devices || []).join(', ') || 'None';
            const live = (u.live_preferences || []).join(', ') || 'None';
            const vod = (u.vod_preferences || []).join(', ') || 'None';
            const custom = u.custom_request || '';
            
            document.getElementById('read-selections').innerHTML = `
                <p><strong>Devices:</strong> ${devices}</p>
                <p class="mt-1"><strong>Live TV:</strong> ${live}</p>
                <p class="mt-1"><strong>VOD:</strong> ${vod}</p>
                ${custom ? `<p class="mt-1 text-red-500"><strong>Custom:</strong> ${custom}</p>` : ''}
            `;
            
            document.getElementById('btn-archive').classList.remove('hidden');
            document.getElementById('user-modal').classList.remove('hidden');
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        document.getElementById('user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const uid = document.getElementById('edit-uid').value;
            
            const data = {
                // Identity
                full_name: document.getElementById('edit-name').value,
                email: document.getElementById('edit-email').value,
                status: document.getElementById('edit-status').value,
                credits_allocated: Number(document.getElementById('edit-credits').value),
                
                // Global Config
                domain_8k: document.getElementById('edit-domain-8k').value,
                m3u_url_8k: document.getElementById('edit-m3u-8k').value,
                epg_url_8k: document.getElementById('edit-epg-8k').value,

                // Licenses Array (The New Schema)
                licenses: currentLicenses,

                // EPGenius
                epgenius_key: document.getElementById('edit-epg-key').value,
                epgenius_url: document.getElementById('edit-epg-drive').value,

                // Internal
                internal_notes: document.getElementById('edit-notes').value
            };

            // Remove legacy fields if they exist to clean up DB (Optional, but good practice)
            // Note: Firestore update doesn't delete fields unless we use FieldValue.delete(), 
            // but overwriting with the new object structure usually suffices for the app logic.

            try {
                if (uid) {
                    await updateDoc(doc(db, 'users', uid), data);
                } else {
                    await addDoc(collection(db, 'users'), { 
                        ...data, 
                        devices: [], 
                        live_preferences: ["Elliot's Default (QC + Sports + English)"], 
                        vod_preferences: ["Elliot's Default (Movies & Series)"], 
                        custom_request: "",
                        created_at: new Date().toISOString() 
                    });
                }
                closeModal('user-modal');
                loadData();
            } catch (err) { alert(err.message); }
        });

        window.archiveUser = async () => {
            const uid = document.getElementById('edit-uid').value;
            if(!uid || !confirm('Are you sure? This hides the user from the list.')) return;
            await updateDoc(doc(db, 'users', uid), { deleted: true });
            closeModal('user-modal');
            loadData();
        };

        // --- SUPPLY ACTIONS ---
        window.openSupplyModal = () => document.getElementById('supply-modal').classList.remove('hidden');

        document.getElementById('supply-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const credits = document.getElementById('supply-credits').value;
            const cost = document.getElementById('supply-cost').value;
            
            const ledgerRef = doc(db, 'business_data', 'ledger');
            try {
                await setDoc(ledgerRef, {
                    supply_log: arrayUnion({
                        credits: Number(credits),
                        cost: Number(cost),
                        date: new Date().toISOString()
                    })
                }, { merge: true });
                closeModal('supply-modal');
                loadData();
            } catch (err) { alert(err.message); }
        });

        // --- UTILITY (SEED DATA) ---
        window.seedData = async () => {
            if(!confirm("Warning: This will reset Devices, Categories, and Product Pricing. Continue?")) return;
            try {
                // 1. App Config - Devices
                const devices = [
                    'Stick: Amazon Fire TV 4K', 'Stick: Chromecast w/ Google TV', 'Stick: Roku 4K (Limited)',
                    'Box: Formuler Z11 Pro', 'Box: Nvidia Shield Pro', 'Box: BuzzTV X5', 'Box: MAG 524 (Legacy)',
                    'TV: Samsung Tizen', 'TV: LG WebOS', 'TV: Android Native (Sony/Hisense)',
                    'Mobile: Android Phone', 'Mobile: iPhone (iOS)', 'Tablet: iPad', 'Tablet: Android Tablet',
                    'PC: Windows', 'PC: Mac OS'
                ];
                await setDoc(doc(db, 'app_config', 'devices'), { list: devices });

                // 2. App Config - Content Categories
                const live_cats = ["Elliot's Default (QC + Sports + English)", "Quebec Premium (French)", "Canada & USA (English)", "International (Europe/Latino)", "Adult 18+", "Other / Custom Request"];
                const vod_cats = ["Elliot's Default (Movies & Series)", "French Content Only", "English Content Only", "International", "Adult", "None", "Other / Custom Request"];
                await setDoc(doc(db, 'app_config', 'content_options'), { live_list: live_cats, vod_list: vod_cats });
                
                // 3. Products
                await setDoc(doc(db, 'products', 'demo_1day'), { name: 'Demo (1 Day)', price: 0, credits: 0 });
                await setDoc(doc(db, 'products', '1_month'), { name: '1 Month Access', price: 10, credits: 1 });
                await setDoc(doc(db, 'products', '3_month'), { name: '3 Months Bundle', price: 25, credits: 3 });
                await setDoc(doc(db, 'products', '6_month'), { name: '6 Months Deal', price: 40, credits: 6 });
                await setDoc(doc(db, 'products', '12_month'), { name: '1 Year VIP', price: 60, credits: 12 });
                
                alert("Database Seeded Successfully! Refresh to see changes.");
                loadData();
            } catch (err) { console.error(err); alert("Error seeding data: " + err.message); }
        };
    </script>
</body>
</html>
